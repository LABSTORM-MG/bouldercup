<!DOCTYPE html>
<html lang="de">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }} â€“ BoulderCup</title>
    <link rel="stylesheet" href="{% static 'css/participant_results.css' %}">
    <link rel="stylesheet" href="{% static 'css/scoreboard.css' %}"
</head>
<body data-admin-message-poll-interval="{{ frontend_config.ADMIN_MESSAGE_POLL_INTERVAL_MS }}"
      data-admin-message-poll-jitter-min="{{ frontend_config.ADMIN_MESSAGE_POLL_JITTER_MIN_MS }}"
      data-admin-message-poll-jitter-max="{{ frontend_config.ADMIN_MESSAGE_POLL_JITTER_MAX_MS }}">
    {% include 'includes/header_back.html' with section_title=title %}
    <main>
        {% if entries %}
            <form method="get" class="age-group-filter">
                <label for="age_group_select" class="muted">Altersgruppe:</label>
                <select id="age_group_select" name="age_group" onchange="this.form.submit()">
                    <option value="all" {% if not selected_group %}selected{% endif %}>Gesamt</option>
                    {% for group in age_groups %}
                        <option value="{{ group.id }}" {% if selected_group and group.id == selected_group.id %}selected{% endif %}>
                            {% if participant.age_group_id and group.id == participant.age_group_id %}* {% endif %}{{ group.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
            <div class="table-wrap">
                <table aria-label="Ergebnisliste" data-grading="{{ grading_system|default:'ifsc' }}" data-participant-id="{{ participant.id }}">
                    <thead>
                        <tr>
                            <th class="rank no-angle"><span class="th-text">Platz</span></th>
                            <th class="name no-angle"><span class="th-text">Teilnehmer</span></th>
                            {% if grading_system == "point_based" or grading_system == "point_based_dynamic" or grading_system == "point_based_dynamic_attempts" %}
                                <th class="attempt-col"><span class="th-text">Punkte</span></th>
                            {% else %}
                                <th class="attempt-col"><span class="th-text">Tops</span></th>
                                <th class="attempt-col"><span class="th-text">Zonen</span></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                            <tr>
                                <td class="rank">{{ entry.rank }}</td>
                                <td class="name">
                                    <a href="{% url 'participant_detail_results' entry.participant.id %}" class="participant-link">
                                        {% if entry.participant.id == participant.id %}
                                            <strong>{{ entry.participant.name }}</strong>
                                        {% else %}
                                            {{ entry.participant.name }}
                                        {% endif %}
                                    </a>
                                </td>
                                {% if grading_system == "point_based" or grading_system == "point_based_dynamic" or grading_system == "point_based_dynamic_attempts" %}
                                    <td class="attempt-col">{{ entry.points }}</td>
                                {% else %}
                                    <td class="attempt-col">{{ entry.tops }} / {{ entry.top_attempts }}</td>
                                    <td class="attempt-col">{{ entry.zones }} / {{ entry.zone_attempts }}</td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="muted">Noch keine Ergebnisse vorhanden.</p>
        {% endif %}
    </main>
    <script>
        const tableBody = document.querySelector("table tbody");
        const pollInterval = 5000;
        const pointBasedSystems = ["point_based", "point_based_dynamic", "point_based_dynamic_attempts"];

        const renderEntries = (entries) => {
            if (!tableBody) return;
            const grading = document.querySelector("table")?.dataset.grading || "ifsc";
            const currentParticipantId = parseInt(document.querySelector("table")?.dataset.participantId || "0");
            const isPointBased = pointBasedSystems.includes(grading);
            const rows = entries.map((e) => {
                const isCurrentUser = e.participant_id === currentParticipantId;
                const nameContent = isCurrentUser ? `<strong>${e.name}</strong>` : e.name;
                const nameLink = `<a href="/dashboard/results/${e.participant_id}/" class="participant-link">${nameContent}</a>`;
                if (isPointBased) {
                    return `
                        <tr>
                            <td class="rank">${e.rank}</td>
                            <td class="name">${nameLink}</td>
                            <td class="attempt-col">${e.points}</td>
                        </tr>
                    `;
                }
                return `
                    <tr>
                        <td class="rank">${e.rank}</td>
                        <td class="name">${nameLink}</td>
                        <td class="attempt-col">${e.tops} / ${e.top_attempts}</td>
                        <td class="attempt-col">${e.zones} / ${e.zone_attempts}</td>
                    </tr>
                `;
            }).join("");
            tableBody.innerHTML = rows;
        };

        const poll = () => {
            fetch(window.location.href, {
                headers: { "X-Requested-With": "XMLHttpRequest" },
            })
                .then((res) => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then((data) => {
                    if (data && data.grading && data.grading !== (document.querySelector("table")?.dataset.grading || "ifsc")) {
                        window.location.reload();
                        return;
                    }
                    if (data && data.entries) renderEntries(data.entries);
                })
                .catch(() => { /* ignore polling errors */ });
        };

        // Add random jitter (3-8 seconds) to prevent all clients polling simultaneously
        const jitter = Math.random() * 5000 + 3000;
        setTimeout(() => {
            setInterval(poll, pollInterval);
        }, jitter);
    </script>
    {% include 'includes/admin_message_poll.html' %}
</body>
</html>
