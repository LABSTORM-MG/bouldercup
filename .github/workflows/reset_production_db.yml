name: Reset Production Database

on:
  workflow_dispatch:
    inputs:
      superuser_username:
        description: 'New superuser username'
        required: true
        type: string
      superuser_password:
        description: 'New superuser password'
        required: true
        type: string

jobs:
  reset-database:
    name: Reset Production Database
    runs-on: ubuntu-latest

    steps:
      - name: Reset database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: labstorm.net
          username: bouldercup-deploy
          port: 2222
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/bouldercup
            source .venv/bin/activate

            # Reset the database (deletes db.sqlite3 and recreates from migrations)
            echo "Resetting database (ALL DATA WILL BE DELETED)..."
            python manage.py reset_participants --confirm

            # Create new superuser
            echo "Creating new superuser..."
            python manage.py shell <<EOF
            from django.contrib.auth.models import User
            User.objects.create_superuser(
                username='${{ github.event.inputs.superuser_username }}',
                email='',
                password='${{ github.event.inputs.superuser_password }}'
            )
            print("Superuser created successfully")
            EOF

            echo "Database reset complete. Superuser created."
