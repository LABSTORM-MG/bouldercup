name: Reset Production Database

on:
  workflow_dispatch:
    inputs:
      admin_username:
        description: 'Admin username for verification'
        required: true
        type: string
      admin_password:
        description: 'Admin password for verification'
        required: true
        type: string
      confirmation:
        description: 'Type "RESET DATABASE" to confirm'
        required: true
        type: string

jobs:
  reset-database:
    name: Reset Production Database
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "RESET DATABASE" ]; then
            echo "Error: Confirmation string does not match. Expected 'RESET DATABASE'"
            exit 1
          fi

      - name: Verify admin credentials and reset database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: labstorm.net
          username: bouldercup-deploy
          port: 2222
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/bouldercup
            source .venv/bin/activate

            # Verify admin credentials using Django shell
            python manage.py shell <<EOF
            import sys
            from django.contrib.auth import authenticate
            from django.contrib.auth.models import User

            username = "${{ github.event.inputs.admin_username }}"
            password = "${{ github.event.inputs.admin_password }}"

            # Try to authenticate as Django superuser
            user = authenticate(username=username, password=password)
            if user is None or not user.is_superuser:
                print("ERROR: Invalid admin credentials or user is not a superuser")
                sys.exit(1)

            print(f"Admin credentials verified for user: {username}")
            EOF

            if [ $? -ne 0 ]; then
              echo "Authentication failed. Aborting database reset."
              exit 1
            fi

            # Create backup before reset
            echo "Creating backup before database reset..."
            python manage.py backup_database

            # Reset the database
            echo "Resetting participant data..."
            python manage.py reset_participants --confirm

            echo "Database reset complete."
