name: Reset Production Database

on:
  workflow_dispatch:

jobs:
  reset-database:
    name: Reset Production Database
    runs-on: ubuntu-latest

    steps:
      - name: Reset database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: labstorm.net
          username: bouldercup-deploy
          port: 2222
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/bouldercup
            source .venv/bin/activate

            # Create backup before reset
            echo "Creating backup before database reset..."
            python manage.py backup_database

            # Reset the database (deletes db.sqlite3 and recreates from migrations)
            echo "Resetting database (ALL DATA WILL BE DELETED)..."
            python manage.py reset_participants --confirm

            echo "Database reset complete. Fresh database created from migrations."
