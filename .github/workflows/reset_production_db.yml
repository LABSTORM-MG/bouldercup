name: Reset Production Database

on:
  workflow_dispatch:
    inputs:
      admin_username:
        description: 'Admin username for verification'
        required: true
        type: string
      admin_password:
        description: 'Admin password for verification'
        required: true
        type: string
      password_confirmation:
        description: 'Repeat your password to confirm'
        required: true
        type: string

jobs:
  reset-database:
    name: Reset Production Database
    runs-on: ubuntu-latest

    steps:
      - name: Validate password confirmation
        run: |
          if [ "${{ github.event.inputs.admin_password }}" != "${{ github.event.inputs.password_confirmation }}" ]; then
            echo "Error: Password confirmation does not match"
            exit 1
          fi

      - name: Verify admin credentials and reset database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: labstorm.net
          username: bouldercup-deploy
          port: 2222
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/bouldercup
            source .venv/bin/activate

            # Verify admin credentials using Django shell
            python manage.py shell <<EOF
            import sys
            from django.contrib.auth import authenticate
            from django.contrib.auth.models import User

            username = "${{ github.event.inputs.admin_username }}"
            password = "${{ github.event.inputs.admin_password }}"

            # Try to authenticate as Django superuser
            user = authenticate(username=username, password=password)
            if user is None or not user.is_superuser:
                print("ERROR: Invalid admin credentials or user is not a superuser")
                sys.exit(1)

            print(f"Admin credentials verified for user: {username}")
            EOF

            if [ $? -ne 0 ]; then
              echo "Authentication failed. Aborting database reset."
              exit 1
            fi

            # Create backup before reset
            echo "Creating backup before complete database reset..."
            python manage.py backup_database

            # Completely reset the database (deletes db.sqlite3 and recreates from migrations)
            echo "Completely resetting database (ALL DATA WILL BE DELETED)..."
            python manage.py reset_participants --confirm

            echo "Database completely reset. Fresh database created from migrations."
